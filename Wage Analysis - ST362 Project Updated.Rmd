---
title: "Wage Analysis - ST362 Project"
author: "Nguyen Hai Trung Pham, Wilfred William"
date: "2025-07-24"
output: html_document
---

```{r}
library(ggplot2)
library(MASS)
library(leaps)
library(car)
library(dplyr)
library(knitr)
library(tidyr)
```

```{r}
# Load the data
wage_data <- read.table("https://raw.githubusercontent.com/WilfredxWZDM/WageAnalysisST362Project/refs/heads/main/wage.data.txt", header = TRUE)

wage_data
```

# 3 - Explanatory Data Analysis

## Full Dataset:

```{r}
summary(wage_data)
```

## Education, Experience, Age, Wage - 6 number summary:

```{r}
summary(wage_data[, c("education", "experience", "age", "wage")])
```

## Distributions (Histogram):

```{r}
ggplot(wage_data, aes(x = wage)) +
  geom_histogram(
    binwidth = diff(range(wage_data$wage)) / 30,
    fill = "skyblue",
    color = "black"
  ) +
  labs(
    title = "Distribution of Wages",
    x = "Hourly Wage ($)",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),           
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = education)) +
  geom_histogram(
    binwidth = 1,
    fill = "skyblue",
    color = "black"
  ) +
  labs(
    title = "Distribution of Education (Years)",
    x = "Years of Education",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = experience)) +
  geom_histogram(
    binwidth = 2,
    fill = "skyblue",
    color = "black"
  ) +
  labs(
    title = "Distribution of Work Experience (Years)",
    x = "Years of Experience",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = age)) +
  geom_histogram(
    binwidth = 3,
    fill = "skyblue",
    color = "black"
  ) +
  labs(
    title = "Distribution of Age",
    x = "Age (Years)",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

```

## Wage by Categorical variables (Box plots):

```{r}
ggplot(wage_data, aes(x = factor(sex), y = wage, fill = factor(sex))) +
  geom_boxplot() +
  scale_fill_manual(
    values = c("0" = "lightblue", "1" = "pink"),
    labels = c("Male", "Female"),
    name = "Sex"
  ) +
  labs(
    title = "Wage by Sex",
    x = "Sex",
    y = "Hourly Wage ($)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),  
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"), 
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(race), y = wage, fill = factor(race))) +
  geom_boxplot(color = "black") +
  scale_fill_manual(
    values = c("1" = "white", "2" = "chocolate", "3" = "beige"),
    labels = c("White", "Black", "Other"),
    name = "Race"
  ) +
  labs(
    title = "Wage by Race",
    x = "Race",
    y = "Hourly Wage ($)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),           
    axis.line = element_line(color = "black"),  
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(union), y = wage, fill = factor(union))) +
  geom_boxplot() +
  scale_fill_manual(
    values = c("0" = "#66c2a5", "1" = "#fc8d62"),
    labels = c("Non-Union", "Union"),
    name = "Union Membership"
  ) +
  scale_x_discrete(labels = c("0" = "Non-Union", "1" = "Union")) +
  labs(
    title = "Hourly Wage by Union Membership",
    x = "Union Membership",
    y = "Hourly Wage ($)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(south), y = wage, fill = factor(south))) +
  geom_boxplot() +
  scale_fill_manual(
    values = c("0" = "#8da0cb", "1" = "#e78ac3"),
    labels = c("Non-South", "South"),
    name = "Region"
  ) +
  scale_x_discrete(labels = c("0" = "Non-South", "1" = "South")) +
  labs(
    title = "Hourly Wage by Region",
    x = "Region",
    y = "Hourly Wage ($)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(marr), y = wage, fill = factor(marr))) +
  geom_boxplot() +
  scale_fill_manual(
    values = c("0" = "#a6d854", "1" = "#ffd92f"),
    labels = c("Not Married", "Married"),
    name = "Marital Status"
  ) +
  scale_x_discrete(labels = c("0" = "Not Married", "1" = "Married")) +
  labs(
    title = "Hourly Wage by Marital Status",
    x = "Marital Status",
    y = "Hourly Wage ($)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(occupation), y = wage, fill = factor(occupation))) +
  geom_boxplot(color = "black") +
  scale_x_discrete(
    labels = c(
      "1" = "Prof/Tech",
      "2" = "Manager/Admin",
      "3" = "Sales",
      "4" = "Clerical",
      "5" = "Service",
      "6" = "Manual"
    )
  ) +
  scale_fill_manual(
    values = c(
      "1" = "#66c2a5",
      "2" = "#fc8d62",
      "3" = "#8da0cb",
      "4" = "#e78ac3",
      "5" = "#a6d854",
      "6" = "#ffd92f"
    ),
    labels = c(
      "Prof/Tech",
      "Manager/Admin",
      "Sales",
      "Clerical",
      "Service",
      "Manual"
    ),
    name = "Occupation"
  ) +
  labs(
    title = "Hourly Wage by Occupation",
    x = "Occupation",
    y = "Hourly Wage ($)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10, angle = 30, hjust = 1),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(sector), y = wage, fill = factor(sector))) +
  geom_boxplot(color = "black") +
  scale_x_discrete(
    labels = c(
      "0" = "Private",
      "1" = "Public",
      "2" = "Non-Profit"
    )
  ) +
  scale_fill_manual(
    values = c(
      "0" = "#66c2a5",
      "1" = "#fc8d62",
      "2" = "#8da0cb"
    ),
    labels = c(
      "Private",
      "Public",
      "Non-Profit"
    ),
    name = "Sector"
  ) +
  labs(
    title = "Hourly Wage by Sector",
    x = "Sector",
    y = "Hourly Wage ($)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )
```

## Distribution of Categorical variables (Bar plots):

```{r}
ggplot(wage_data, aes(x = factor(sex), fill = factor(sex))) +
  geom_bar(color = "black") +
  scale_x_discrete(labels = c("0" = "Male", "1" = "Female")) +
  scale_fill_manual(
    values = c("0" = "lightblue", "1" = "pink"),
    labels = c("Male", "Female"),
    name = "Sex"
  ) +
  labs(
    title = "Count of Individuals by Sex",
    x = "Sex",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(race), fill = factor(race))) +
  geom_bar(color = "black") +
  scale_x_discrete(labels = c("1" = "White", "2" = "Black", "3" = "Other")) +
  scale_fill_manual(
    values = c("1" = "white", "2" = "chocolate", "3" = "beige"),
    labels = c("White", "Black", "Other"),
    name = "Race"
  ) +
  labs(
    title = "Count of Individuals by Race",
    x = "Race",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(union), fill = factor(union))) +
  geom_bar(color = "black") +
  scale_x_discrete(labels = c("0" = "Non-Union", "1" = "Union")) +
  scale_fill_manual(
    values = c("0" = "#66c2a5", "1" = "#fc8d62"),
    labels = c("Non-Union", "Union"),
    name = "Union Membership"
  ) +
  labs(
    title = "Count of Individuals by Union Membership",
    x = "Union Membership",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(south), fill = factor(south))) +
  geom_bar(color = "black") +
  scale_x_discrete(labels = c("0" = "Non-South", "1" = "South")) +
  scale_fill_manual(
    values = c("0" = "#8da0cb", "1" = "#e78ac3"),
    labels = c("Non-South", "South"),
    name = "Region"
  ) +
  labs(
    title = "Count of Individuals by Region",
    x = "Region",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(marr), fill = factor(marr))) +
  geom_bar(color = "black") +
  scale_x_discrete(labels = c("0" = "Not Married", "1" = "Married")) +
  scale_fill_manual(
    values = c("0" = "#a6d854", "1" = "#ffd92f"),
    labels = c("Not Married", "Married"),
    name = "Marital Status"
  ) +
  labs(
    title = "Count of Individuals by Marital Status",
    x = "Marital Status",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(occupation), fill = factor(occupation))) +
  geom_bar(color = "black") +
  scale_x_discrete(labels = c(
    "1" = "Prof/Tech",
    "2" = "Manager/Admin",
    "3" = "Sales",
    "4" = "Clerical",
    "5" = "Service",
    "6" = "Manual"
  )) +
  scale_fill_manual(
    values = c(
      "1" = "#66c2a5",
      "2" = "#fc8d62",
      "3" = "#8da0cb",
      "4" = "#e78ac3",
      "5" = "#a6d854",
      "6" = "#ffd92f"
    ),
    labels = c(
      "Prof/Tech",
      "Manager/Admin",
      "Sales",
      "Clerical",
      "Service",
      "Manual"
    ),
    name = "Occupation"
  ) +
  labs(
    title = "Count of Individuals by Occupation",
    x = "Occupation",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10, angle = 30, hjust = 1),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )

ggplot(wage_data, aes(x = factor(sector), fill = factor(sector))) +
  geom_bar(color = "black") +
  scale_x_discrete(labels = c(
    "0" = "Private",
    "1" = "Public",
    "2" = "Non-Profit"
  )) +
  scale_fill_manual(
    values = c(
      "0" = "#66c2a5",
      "1" = "#fc8d62",
      "2" = "#8da0cb"
    ),
    labels = c(
      "Private",
      "Public",
      "Non-Profit"
    ),
    name = "Sector"
  ) +
  labs(
    title = "Count of Individuals by Sector",
    x = "Sector",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  )
```

# 4 - Confirmatory Data Analysis

## Data Cleaning:

```{r}
wage_data <- read.table("https://raw.githubusercontent.com/WilfredxWZDM/WageAnalysisST362Project/refs/heads/main/wage.data.txt", header = TRUE)

wage_data$sex <- factor(wage_data$sex, levels = c(0, 1), labels = c("Male", "Female"))
wage_data$race <- factor(wage_data$race, levels = c(1, 2, 3), labels = c("White", "Black", "Other"))
wage_data$south <- factor(wage_data$south, levels = c(0, 1), labels = c("Non-South", "South"))
wage_data$union <- factor(wage_data$union, levels = c(0, 1), labels = c("Non-Union", "Union"))
wage_data$marr <- factor(wage_data$marr, levels = c(0, 1), labels = c("Not Married", "Married"))
wage_data$occupation <- factor(wage_data$occupation, levels = 1:6,
                               labels = c("Professional/Technical", "Manager/Admin", "Sales", 
                                          "Clerical", "Service", "Manual"))
wage_data$sector <- factor(wage_data$sector, levels = 0:2,
                           labels = c("Private", "Public", "Non-Profit"))

wage_data
```

## Full model:

### Un-transformed:

```{r}
model_untransformed <- lm(wage ~ education + experience + age + sex + race + south + union + marr + occupation + sector, data = wage_data)
summary(model_untransformed)
```

### Box-cox transformation:

```{r}
boxcox(model_untransformed, lambda = seq(-2, 2, 0.1))
```

### Log transformation (since lambda = 0):

```{r}
wage_data$log_wage <- log(wage_data$wage)
model_log_full <- lm(log_wage ~ education + experience + age + sex + race + south + union + marr + occupation + sector, data = wage_data)
summary(model_log_full)
model_log_full
```

### Transformed "Wages" Normality check:

```{r}
ggplot(wage_data, aes(x = log(wage))) +
  geom_histogram(
    binwidth = diff(range(log(wage_data$wage))) / 30,
    fill = "skyblue",
    color = "black"
  ) +
  labs(
    title = "Distribution of Log-Transformed Wages",
    x = "Log(Hourly Wage)",
    y = "Frequency"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10)
  )

par(mfrow = c(1, 2))

qqnorm(wage_data$wage, main = "Q-Q Plot: Original Wage")
qqline(wage_data$wage, col = "red")

qqnorm(log(wage_data$wage), main = "Q-Q Plot: Log(Wage)")
qqline(log(wage_data$wage), col = "blue")
par(mfrow = c(1, 1))
```

### Comparison of two models (log-transformed vs. un-transformed):

#### Adjusted R^2^:

```{r}
summary(model_untransformed)$adj.r.squared
summary(model_log_full)$adj.r.squared
```

## Influential Observations (Outliers):

### Leverage:

```{r}
n <- nrow(wage_data)
p <- length(coef(model_log_full)) - 1
hii <- hatvalues(model_log_full)
threshold_hii <- 2 * (p + 1) / n
flag_hii <- which(hii > threshold_hii)
```

### Cook's Distance:

```{r}
cookD <- cooks.distance(model_log_full)
flag_cook <- which(cookD > 4/n)
```

### DFFITS:

```{r}
dffits_values <- dffits(model_log_full)
threshold_dffits <- 2 * sqrt((p + 1) / n)
flag_dffits <- which(abs(dffits_values) > threshold_dffits)
```

### DFBetas:

```{r}
dfbetas_values <- dfbetas(model_log_full)
threshold_dfbeta <- 2 / sqrt(n)
flag_dfbetas <- which(apply(abs(dfbetas_values), 1, function(row) any(row > threshold_dfbeta)))
```

### COVRATIO:

```{r}
covratios <- covratio(model_log_full)
cov_low <- 1 - 3 * (p + 1) / n
cov_high <- 1 + 3 * (p + 1) / n
flag_covratio <- which(covratios < cov_low | covratios > cov_high)
```

### Remove Influential Observations:

```{r}
# Combine flags
all_flags <- c(flag_hii, flag_cook, flag_dffits, flag_dfbetas, flag_covratio)
influential_counts <- table(all_flags)
most_influential <- as.numeric(names(influential_counts[influential_counts >= 3]))

# Remove influential observations
wage_data_clean <- wage_data[-most_influential, ]

wage_data_clean

```

### Refit model without influential points:

```{r}
model_clean <- lm(log_wage ~ education + experience + age + sex + race + south + union + marr + occupation + sector, data = wage_data_clean)
summary(model_clean)
```

### Comparison (with vs. without outliers):

```{r}
par(mfrow = c(2, 2))
plot(model_log_full, main = "Full Model")
plot(model_clean, main = "Cleaned Model")
```

## Variable Selection:

### Step wise AIC:

```{r}
model_log_null <- lm(log_wage ~ 1, data = wage_data_clean)

step_model_AIC <- step(model_log_null, 
                       scope = list(lower = model_log_null, upper = model_clean),
                       direction = "both", trace = TRUE)
```

### Step wise BIC:

```{r}
step_model_BIC <- step(model_log_null, 
                       scope = list(lower = model_log_null, upper = model_clean),
                       direction = "both",
                       k = log(nrow(wage_data_clean)),
                       trace = TRUE)
```

### Best model based on AIC and BIC:

```{r}
summary(step_model_AIC)
```

```{r}
summary(step_model_BIC)
```

### Adjusted R^2:

```{r}
X <- model.matrix(log_wage ~ education + experience + age + sex + race +
                  south + union + marr + occupation + sector, 
                  data = wage_data_clean)[, -1] 

y <- wage_data_clean$log_wage

wage_model_df <- data.frame(log_wage = y, X)

regsubsets_log <- regsubsets(log_wage ~ ., 
                             data = wage_model_df, 
                             nbest = 1, 
                             nvmax = 20)  

summary_log <- summary(regsubsets_log)
best_index <- which.max(summary_log$adjr2)
best_vars <- summary_log$which[best_index, ]
cat("Best model uses", sum(best_vars) - 1, "variables with Adjusted R^2 of", 
    summary_log$adjr2[best_index], "\n")

print(best_vars)

selected_vars <- names(best_vars)[best_vars][-1]  

best_formula <- as.formula(paste("log_wage ~", paste(selected_vars, collapse = " + ")))
```

### Best model based on Adjusted R^2:

```{r}
best_model <- lm(best_formula, data = wage_model_df)
summary(best_model)
```

## Model Diagnostics & Validation:

### Significance test:

```{r}
final_model <- lm(log_wage ~ occupation + sex + age + education + union + south + marr + race + sector, data = wage_data_clean)
summary(final_model)
```

### Multicollinearity:

#### VIF:

```{r}
vif(final_model)
```

#### Correlation Matrix (continuous variables):

```{r}
numeric_vars <- wage_data_clean[, c("wage", "education", "experience", "age")]
cor_matrix <- cor(numeric_vars)
round(cor_matrix, 2)

cor_df <- as.data.frame(as.table(cor_matrix))

ggplot(cor_df, aes(Var1, Var2, fill = Freq)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(Freq, 2)), color = "black", size = 4) +
  scale_fill_gradient2(
    low = "#2E8B57",  
    mid = "white",
    high = "#FFA500", 
    midpoint = 0,
    limit = c(-1, 1),
    name = "Correlation"
  ) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Correlation Matrix",
    x = NULL,
    y = NULL
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 18),
    panel.grid = element_blank()
  )
```
# ANOVA Table and Model Fit Analysis
```{r}
anova_results <- anova(final_model)
print(anova_results)
```

### Residual Analysis:

#### Linearity: Residual vs. Fitted

```{r}
res_df <- data.frame(
  Fitted = fitted(final_model),
  Residuals = resid(final_model)
)

ggplot(res_df, aes(x = Fitted, y = Residuals)) +
  geom_point(color = "blue", alpha = 0.8) +
  geom_hline(yintercept = 0, color = "red", linetype = "solid") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Residuals vs. Fitted Values",
    x = "Fitted Values",
    y = "Residuals"
  ) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

#### Normality: Q-Q plot

```{r}
ggplot(res_df, aes(sample = Residuals)) +
  stat_qq(color = "blue", alpha = 0.6) +
  stat_qq_line(color = "red", linetype = "solid") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Q-Q Plot of Residuals",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

#### Homoscedasticity: Scale-Location Plot

```{r}
res_df$StdRes <- sqrt(abs(scale(resid(final_model))))

ggplot(res_df, aes(x = Fitted, y = StdRes)) +
  geom_point(color = "blue", alpha = 0.8) +
  geom_smooth(method = "loess", color = "red", se = FALSE) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Scale-Location Plot",
    x = "Fitted Values",
    y = "√|Standardized Residuals|"
  ) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

#### Influential Observations: Residual vs. Leverage

```{r}
res_df <- data.frame(
  Fitted = fitted(final_model),
  Residuals = resid(final_model),
  Leverage = hatvalues(final_model),      
  StdRes = rstandard(final_model)           
)

ggplot(res_df, aes(x = Leverage, y = StdRes)) +
  geom_point(color = "blue", alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = "solid", color = "red") +
  theme_minimal(base_size = 14) +
  labs(
    title = "Standardized Residuals vs. Leverage",
    x = "Leverage",
    y = "Standardized Residuals"
  ) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

# Key Analyses and Results

## 5.1 South vs North
```{r}
aggregate(wage ~ south, data = wage_data_clean, FUN = mean)
```


## 5.2 Education vs Experience
```{r}
long_data <- wage_data_clean %>%
  select(wage, education, experience) %>%
  pivot_longer(cols = c(education, experience),
               names_to = "Predictor",
               values_to = "Value")

ggplot(long_data, aes(x = Value, y = wage, color = Predictor)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(title = "Predicted Wage vs Education and Experience",
       x = "Years of Education / Experience",
       y = "Predicted Wage ($/hr)",
       color = "Predictor") +
  theme_minimal()
```


## 5.3 Marriage Impact by Gender
```{r}
wage_data_clean %>%
  group_by(sex, marr) %>%
  summarize(mean_wage = mean(wage)) %>%
  ggplot(aes(x = sex, y = mean_wage, fill = marr)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Predicted Wages by Marital Status and Gender",
       x = "Sex", y = "Predicted Wage ($/hr)", fill = "Marital Status")
```


## 5.4 Unequal Returns to Education Across Race
```{r}
wage_data_clean %>%
  mutate(edu_group = cut(education, breaks = c(0,12,16,20), labels = c("High School", "College", "Grad"))) %>%
  group_by(race, edu_group) %>%
  summarize(mean_wage = mean(wage)) %>%
  ggplot(aes(x = race, y = mean_wage, fill = edu_group)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Predicted Wage by Race and Education Group",
       x = "Race", y = "Predicted Wage ($/hr)", fill = "Education Level")
        
```



## 5.5 Analyze Characteristics of Wage Outliers
```{r}
top_outlier <- wage_data_clean[which.max(wage_data_clean$wage), ]
bottom_outlier <- wage_data_clean[which.min(wage_data_clean$wage), ]

kable(rbind(top_outlier, bottom_outlier)[, c("education", "experience", "age", "sex", "race", "union", "occupation", "sector", "wage")],
      caption = "Characteristics of Highest vs. Lowest Predicted Wage Profiles")
```

## 5.6 Simulate More Unionization and Education
```{r}
set.seed(42)
sim_data <- wage_data_clean

non_union_indices <- which(sim_data$union == "Non-Union")
convert_n <- round(0.2 * length(non_union_indices))
convert_ids <- sample(non_union_indices, convert_n)
sim_data$union[convert_ids] <- "Union"

sim_data$education <- sim_data$education + 2

sim_data$predicted_log_wage <- predict(model_clean, newdata = sim_data)
sim_data$predicted_wage <- exp(sim_data$predicted_log_wage)

original_mean <- mean(wage_data_clean$wage)
simulated_mean <- mean(sim_data$predicted_wage)

print(data.frame(
  Scenario = c("Original", "Simulated"),
  Mean_Wage = c(original_mean, simulated_mean),
  Change = c(NA, simulated_mean - original_mean)
))

ggplot(data.frame(
  Scenario = c("Original", "Simulated"),
  Mean_Wage = c(original_mean, simulated_mean)
), aes(x = Scenario, y = Mean_Wage)) +
  geom_bar(stat = "identity", fill = c("gray", "skyblue")) +
  labs(title = "Simulation: Increased Unionization and Education",
       y = "Mean Wage ($/hr)")

```

